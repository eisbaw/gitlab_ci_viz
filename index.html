<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitLab CI GANTT Visualizer</title>
    <link href="/static/vis-timeline-graph2d-8.3.1.min.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #visualization {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
            background-color: white;
        }
        #status {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e8f4f8;
            border-radius: 4px;
        }
        h1 {
            margin-top: 0;
        }

        /* Status color palette */
        :root {
            --status-success-bg: #28a745;
            --status-success-border: #1e7e34;
            --status-failed-bg: #dc3545;
            --status-failed-border: #bd2130;
            --status-running-bg: #007bff;
            --status-running-border: #0056b3;
            --status-neutral-bg: #6c757d;
            --status-neutral-border: #545b62;
            --status-canceled-bg: #fd7e14;
            --status-canceled-border: #dc6502;
        }

        /* Pipeline status colors */
        .vis-item.pipeline-success {
            background-color: var(--status-success-bg);
            border-color: var(--status-success-border);
            color: white;
        }
        .vis-item.pipeline-failed {
            background-color: var(--status-failed-bg);
            border-color: var(--status-failed-border);
            color: white;
        }
        .vis-item.pipeline-running {
            background-color: var(--status-running-bg);
            border-color: var(--status-running-border);
            color: white;
        }
        .vis-item.pipeline-pending,
        .vis-item.pipeline-skipped,
        .vis-item.pipeline-manual,
        .vis-item.pipeline-created {
            background-color: var(--status-neutral-bg);
            border-color: var(--status-neutral-border);
            color: white;
        }
        .vis-item.pipeline-canceled,
        .vis-item.pipeline-cancelled {
            background-color: var(--status-canceled-bg);
            border-color: var(--status-canceled-border);
            color: white;
        }

        /* Job status colors */
        .vis-item.job-success {
            background-color: var(--status-success-bg);
            border-color: var(--status-success-border);
            color: white;
        }
        .vis-item.job-failed {
            background-color: var(--status-failed-bg);
            border-color: var(--status-failed-border);
            color: white;
        }
        .vis-item.job-running {
            background-color: var(--status-running-bg);
            border-color: var(--status-running-border);
            color: white;
        }
        .vis-item.job-pending,
        .vis-item.job-skipped,
        .vis-item.job-manual,
        .vis-item.job-created {
            background-color: var(--status-neutral-bg);
            border-color: var(--status-neutral-border);
            color: white;
        }
        .vis-item.job-canceled,
        .vis-item.job-cancelled {
            background-color: var(--status-canceled-bg);
            border-color: var(--status-canceled-border);
            color: white;
        }
    </style>
    <!-- CONFIG object injected here by serve.py as <script> tag -->
</head>
<body>
    <h1>GitLab CI GANTT Visualizer</h1>
    <div id="status">Loading configuration...</div>
    <div id="visualization"></div>

    <script src="/static/vis-timeline-graph2d-8.3.1.min.js"></script>
    <script src="/static/api-client.js"></script>
    <script src="/static/data-transformer.js"></script>
    <script>
        // Global timeline instance
        let timeline = null;

        // Global API client instance
        let apiClient = null;

        // Display configuration status and initialize timeline
        document.addEventListener('DOMContentLoaded', function() {
            const statusDiv = document.getElementById('status');

            // Initialize API client
            try {
                apiClient = new GitLabAPIClient();

                let statusHtml = '<strong>Configuration loaded successfully:</strong><br>';
                statusHtml += `GitLab URL: ${CONFIG.gitlabUrl}<br>`;
                statusHtml += `Time range: since ${CONFIG.since}<br>`;

                if (CONFIG.groupId) {
                    statusHtml += `Group ID: ${CONFIG.groupId}<br>`;
                } else if (CONFIG.projectIds) {
                    statusHtml += `Project IDs: ${CONFIG.projectIds.join(', ')}<br>`;
                }

                statusHtml += `Token: ✓ Present<br>`;
                statusHtml += `API Client: ✓ Initialized<br>`;
                statusDiv.innerHTML = statusHtml;
                statusDiv.style.backgroundColor = '#e8f8e8';
            } catch (error) {
                statusDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                statusDiv.style.backgroundColor = '#ffe8e8';
                return; // Stop initialization if API client fails
            }

            // Test vis.js library
            if (typeof vis === 'undefined') {
                statusDiv.innerHTML += '<br><strong>Error:</strong> vis.js library not loaded';
                statusDiv.style.backgroundColor = '#ffe8e8';
                return;
            }

            // Test DataTransformer module
            if (typeof DataTransformer === 'undefined') {
                statusDiv.innerHTML += '<br><strong>Error:</strong> DataTransformer module not loaded';
                statusDiv.style.backgroundColor = '#ffe8e8';
                return;
            }

            statusDiv.innerHTML += 'vis.js library: ✓ Loaded<br>';
            statusDiv.innerHTML += 'DataTransformer: ✓ Loaded';

            // Initialize Timeline
            initializeTimeline();

            // Fetch and render data
            fetchAndRender();
        });

        /**
         * Initialize vis.js Timeline component with GANTT chart configuration
         */
        function initializeTimeline() {
            const container = document.getElementById('visualization');

            // Cleanup if timeline already exists (defensive, idempotent)
            if (timeline) {
                timeline.destroy();
            }

            // Create empty datasets for now (will be populated by API data)
            const items = new vis.DataSet([]);
            const groups = new vis.DataSet([]);

            // Timeline options for GANTT chart style
            // Show dates in day/month context, times in HH:mm format
            // Helps operators quickly identify when pipelines ran
            const options = {
                // Stack items within groups
                stack: true,

                // Show current time line
                showCurrentTime: true,

                // Time axis format
                format: {
                    minorLabels: {
                        minute: 'HH:mm',
                        hour: 'HH:mm'
                    },
                    majorLabels: {
                        minute: 'ddd D MMMM',
                        hour: 'ddd D MMMM',
                        day: 'MMMM YYYY'
                    }
                },

                // Orientation
                orientation: 'top',

                // Enable grouping
                groupOrder: 'content',

                // Enable dragging and zooming
                zoomable: true,
                moveable: true,

                // Tooltip
                tooltip: {
                    followMouse: true,
                    overflowMethod: 'cap'
                },

                // Margins
                margin: {
                    item: {
                        horizontal: 10,
                        vertical: 5
                    }
                }
            };

            // Create Timeline instance
            timeline = new vis.Timeline(container, items, groups, options);

            console.log('Timeline initialized successfully');
        }

        /**
         * Fetch GitLab data and render on timeline
         *
         * Orchestrates the complete data flow:
         * 1. Fetch projects from GitLab API
         * 2. Fetch pipelines for those projects
         * 3. Fetch jobs for those pipelines
         * 4. Transform to vis.js format
         * 5. Update timeline with transformed data
         */
        async function fetchAndRender() {
            const statusDiv = document.getElementById('status');

            try {
                // Update status
                statusDiv.innerHTML += '<br><br><strong>Fetching data from GitLab...</strong>';

                // Step 1: Fetch projects
                statusDiv.innerHTML += '<br>Fetching projects...';
                const projects = await apiClient.fetchProjects();
                statusDiv.innerHTML += ` ✓ (${projects.length} projects)`;

                // Create project map for quick lookup
                const projectMap = new Map();
                projects.forEach(p => projectMap.set(p.id, p));

                // Step 2: Fetch pipelines
                statusDiv.innerHTML += '<br>Fetching pipelines...';
                const pipelines = await apiClient.fetchPipelines(projects);
                statusDiv.innerHTML += ` ✓ (${pipelines.length} pipelines)`;

                if (pipelines.length === 0) {
                    statusDiv.innerHTML += '<br><strong>No pipelines found for the specified time range.</strong>';
                    return;
                }

                // Step 3: Fetch jobs
                statusDiv.innerHTML += '<br>Fetching jobs...';
                const jobs = await apiClient.fetchJobs(pipelines);
                statusDiv.innerHTML += ` ✓ (${jobs.length} jobs)`;

                // Step 4: Transform to vis.js format
                statusDiv.innerHTML += '<br>Transforming data...';
                const transformed = DataTransformer.transform(pipelines, jobs);

                // Step 5: Enrich pipeline items with project names
                const enrichedItems = transformed.items.map(item => {
                    // Check if this is a pipeline item (not a job item)
                    if (item.id.startsWith('pipeline-item-')) {
                        const pipelineId = parseInt(item.id.replace('pipeline-item-', ''), 10);
                        const pipeline = pipelines.find(p => p.id === pipelineId);

                        if (!pipeline) {
                            throw new Error(
                                `Data integrity error: Timeline item references unknown pipeline ${pipelineId}. ` +
                                `This should never happen - indicates bug in DataTransformer.`
                            );
                        }

                        const project = projectMap.get(pipeline.project_id);
                        if (!project) {
                            throw new Error(
                                `Data integrity error: Pipeline ${pipelineId} references unknown project ${pipeline.project_id}. ` +
                                `Available projects: [${Array.from(projectMap.keys()).join(', ')}]`
                            );
                        }

                        // Return enriched item (immutable)
                        return {
                            ...item,
                            content: `${project.name} #${pipeline.id}`
                        };
                    }

                    // Return non-pipeline items unchanged
                    return item;
                });

                statusDiv.innerHTML += ' ✓';

                // Step 6: Update timeline
                statusDiv.innerHTML += '<br>Rendering timeline...';
                timeline.setGroups(transformed.groups);
                timeline.setItems(enrichedItems);
                statusDiv.innerHTML += ' ✓';

                statusDiv.innerHTML += '<br><br><strong style="color: green;">Data loaded successfully!</strong>';

            } catch (error) {
                console.error('Error fetching and rendering data:', error);
                statusDiv.innerHTML += `<br><br><strong style="color: red;">Error: ${error.message}</strong>`;
                statusDiv.style.backgroundColor = '#ffe8e8';
            }
        }
    </script>
</body>
</html>
